# Lab 2.1: Containerizing Recommendation Service for Azure Container Apps - [Read Only]

In this lab, you'll explore the process of containerizing a recommendation service and deploying it to Azure Container Apps. Containerization has become a key strategy in modern application development and deployment, providing a consistent and reproducible environment across various stages of the software development lifecycle. Azure Container Apps, part of Microsoft's Azure cloud platform, offers a managed container service that enables developers to deploy and scale containerized applications seamlessly.

   > **Note**: This lab has been automated; you can skip to Lab 2.2 to verify and review the containerized recommendation service in the Azure Container App.

### Task 1: Build Docker images for the recommendation service

1. Open the **Docker** application from the Lab VM desktop by double-clicking on it.

   ![](./Media/docker1.png)
   
1. In the **Docker Subscription Service Agreement** window, click **Accept**.

   ![](./Media/docker2.png)

1. In the **Welcome to Docker Desktop** window, click on **Continue without signing in**.

   ![](./Media/without-signin.png)

1. In the **Tell us about the work you do** window, click on **Skip**.

1. Navigate back to the **Visual Studio code** window and navigate to **miyagi/services/recommendation-service/dotnet**. Right-click on dotnet in the cascading menu and select **Open in integrate Terminal**.

1. Run the following command to build a **Docker image**:

   ```
   docker build --no-cache -t miyagi-recommendation .   
   ```

   ![](./Media/task2-1.png)

   > **Note**: Please wait, as this command may require some time to complete.

1. Run the following command to get the newly created image:

   ```
   docker images
   ```
   
   ![](./Media/task2-2.png)

1. Navigate back to the **Docker desktop**, and from the left pane, select **Images**.

   ![](./Media/docker7.png)

1. In the **Images** blade, notice the **miyagi-recommendation(1)** image has been created. Select the **run(2)** icon .

   ![](./Media/docker13.png)

1. In the **Run a new container** window, select the drop-down arrow.

   ![](./Media/docker14-(1).png)

1. In the **Run a new container**, under **Ports** for **Host Port**, enter **5224** and click on **Run**.

    ![](./Media/recommendation-port.png)

1. Click on the **5224:80** URL link.

   ![](./Media/recommendation-port-open.png)
   
1. You should be able to see the application running locally.
   
   ![](./Media/docker-recommend.png)

### Task 2: Push the Docker image of the recommendation service to the container registry

In this task, you'll push Miyagi-recommendation images to acr. 

1. Navigate back to the **Visual Studio code** window and navigate to **miyagi/services/recommendation-service/dotnet**. Right-click on dotnet in the cascading menu and select **Open in integrate Terminal**.

1. Run the following command to log in to the **Azure portal**:

    ```
    az login
    ```

1. This will redirect to the **Microsoft login page**. Select your Azure account **<inject key="AzureAdUserEmail"></inject>** and navigate back to the **Visual Studio code**.

   ![](./Media/azure-account-select.png)

1. Run the following command to log in to an **Azure Container Registry (ACR)** using the Azure CLI.

   > **Note**: Please replace **[ACRname]** and **[uname]** with **<inject key="AcrUsername" enableCopy="true"/>**, and **[password]** with **<inject key="AcrPassword" enableCopy="true"/>**.
   
   ```
   az acr login -n [ACRname] -u [uname] -p [password]
   ```

   ![](./Media/task2-5.png)
    
1. Run the following command to add the tag:

   > **Note**: Please replace **[ACRname]** with **<inject key="AcrLoginServer" enableCopy="true"/>**.

   ```
   docker tag miyagi-recommendation:latest [ACRname]/miyagi-recommendation:latest
   ```

1. Run the following command to push the image to the container registry:

   > **Note**: Please replace **[ACRname]** with **<inject key="AcrLoginServer" enableCopy="true"/>**.

   ```
   docker push [ACRname]/miyagi-recommendation:latest
   ```

   ![](./Media/task2-6.png)

### Task 3: Create a container app for the recommendation service

In this task, you will be creating a container app for the recommendation.

1. Run the following command to create a **Container App environment**:

   > **Note**: Please replace **[DID]** with **<inject key="DeploymentID" enableCopy="true"/>** and **[Region]** with **<inject key="Region" enableCopy="true"/>**.

   ```
   az containerapp env create --name env-miyagi-[DID] --resource-group miyagi-rg-[DID] --location [Region]
   ```

1. Run the following command to create a **Container App**:

   > **Note**: Please replace **[DID]** with **<inject key="DeploymentID" enableCopy="true"/>**, **[ACRname]** with **<inject key="AcrLoginServer" enableCopy="true"/>**, **[uname]** with **<inject key="AcrUsername" enableCopy="true"/>**, and **[password]** with **<inject key="AcrPassword" enableCopy="true"/>**.

   ```
   az containerapp create --name ca-miyagi-rec-[DID] --resource-group miyagi-rg-[DID] --image [ACRname]/miyagi-recommendation:latest --environment env-miyagi-[DID] --registry-server [ACRname] --registry-username [uname] --registry-password [password]
   ```

1. Run the following command to enable **Container App ingress**:

   > **Note**: Please replace **[DID]** with **<inject key="DeploymentID" enableCopy="true"/>**
   
   ```
   az containerapp ingress enable -n ca-miyagi-rec-[DID] -g miyagi-rg-[DID] --type external --allow-insecure --target-port 80
   ```

### Task 4: Verify recommendation service using Swagger


1. In the Azure Portal page, in the Search resources, services, and docs (G+/) box at the top of the portal, enter **Container Apps (1)**, and then select **Container Apps (2)** under services.

   ![](./Media/container-app-select.png)

1. In the **Container Apps** blade, select **ca-miyagi-rec-<inject key="DeploymentID" enableCopy="false"/>**.

   ![](./Media/container-ca-miyagi.png)

1. In the **ca-miyagi-rec-<inject key="DeploymentID" enableCopy="false"/>** page, from the left navigation pane, select **Ingress** **(1)** under setting session and click on **Endpoints** **(2)** URL link.

   ![](./Media/container-ca-ingress.png)

1. You can view the **Miyagi Recommendation Service** website running through the Container Apps.

   ![](./Media/online-output-recommendation.png)    

1. Now, click on **Next** from the lower right corner to move to the next page.
